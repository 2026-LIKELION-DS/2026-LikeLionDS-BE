name: ğŸš€ Deploy to EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œí•  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v3
    
    # 2. Docker Hub ë¡œê·¸ì¸
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
    - name: ğŸ—ï¸ Build and Push Docker image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/likelion-backend:latest .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/likelion-backend:latest
    
    # 4. EC2 ë°°í¬
    - name: ğŸš¢ Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ“ Creating configuration files..."
          # .env íŒŒì¼ ìƒì„±
          echo "${{ secrets.ENV_FILE }}" > ~/deploy/.env
          
          # secret_key.json ìƒì„±
          echo '${{ secrets.SECRET_KEY_JSON }}' > ~/deploy/secret_key.json
          
          echo "ğŸ³ Pulling Docker image..."
          # Docker ì´ë¯¸ì§€ í’€
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/likelion-backend:latest
          
          echo "ğŸ›‘ Stopping existing container..."
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          docker stop likelion-backend || true
          docker rm likelion-backend || true
          
          echo "â–¶ï¸ Starting new container..."
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name likelion-backend \
            -p 8000:8000 \
            -v ~/deploy/.env:/reqruitment/.env \
            -v ~/deploy/secret_key.json:/reqruitment/secret_key.json \
            --restart always \
            ${{ secrets.DOCKERHUB_USERNAME }}/likelion-backend:latest
          
          echo "ğŸ“‚ Copying static files..."
          # Static íŒŒì¼ ì¬ë³µì‚¬
          sleep 5
          docker cp likelion-backend:/reqruitment/staticfiles /home/ubuntu/staticfiles_temp
          sudo rm -rf /home/ubuntu/staticfiles
          sudo mv /home/ubuntu/staticfiles_temp /home/ubuntu/staticfiles
          sudo chown -R ubuntu:ubuntu /home/ubuntu/staticfiles
          sudo chmod -R 755 /home/ubuntu/staticfiles
          
          echo "ğŸ“‹ Container logs:"
          # ë¡œê·¸ í™•ì¸
          docker logs --tail 50 likelion-backend
          
          echo "âœ… Deployment completed successfully!"